name: build

on:  
  push:
    paths-ignore:
    - "README.md"
    - "docs/**"
    branches:
    - main

jobs:
  build:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [ubuntu-latest]
        lazarus-versions: [2.2.2]
    steps:
    - uses: actions/checkout@v2
    - uses: gcarreno/setup-lazarus@v3.2
      with:
        lazarus-version: ${{ matrix.lazarus-versions }}
        with-cache: true

    - name: Download and extract BOSS (Linux)
      if: ${{ matrix.operating-system == 'ubuntu-latest' }}
      run: |
        curl -LOk https://github.com/HashLoad/boss/releases/download/v3.0.9/boss-linux-amd64.zip
        unzip boss-linux-amd64.zip
        chmod +x ./linux-amd64/boss
        echo "$GITHUB_WORKSPACE/linux-amd64" >> $GITHUB_PATH

    - name: Download and extract BOSS (Windows)
      if: ${{ matrix.operating-system == 'windows-2019' }}
      run: |
        curl -LOk https://github.com/HashLoad/boss/releases/download/v3.0.9/boss-windows-amd64.zip
        unzip boss-windows-amd64.zip
        echo (Join-Path $env:GITHUB_WORKSPACE "windows-amd64") | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: BOSS Update packages
      run: boss update
      
    - run: mkdir -p ~/artifacts
    - run: mkdir -p ~/artifacts/linux
    - run: mkdir -p ~/artifacts/windows
    - run: mkdir -p ~/artifacts/macos
    
    - name: Build the Main Application (linux-x64)
      run: lazbuild "pasc.lpi" --build-mode=Release
    - run: cp ./pasc ~/artifacts/linux/pasc
    
    - name: Build the Unit Tests Application (linux-x64)
      run: lazbuild "tests/TestPasc.lpi"
    - run: cp tests/TestPasc ~/artifacts/linux/TestPasc
    
    - name: Run the Unit Tests Application
      run: tests/TestPasc "--all" "--format=plain"
      
    - name: Build the Main Application (win64)
      run: lazbuild "pasc.lpi" --build-mode=Release -B --os=win64
    - run: cp ./pasc.exe ~/artifacts/windows/pasc.exe
    
    - name: Build the Unit Tests Application (win64)
      run: lazbuild "tests/TestPasc.lpi" -B --os=win64
    - run: cp tests/TestPasc.exe ~/artifacts/windows/TestPasc.exe
    
    - name: Build the Main Application (macos)
      run: lazbuild "pasc.lpi" --build-mode=Release -B --os=darwin
    - run: cp ./pasc ~/artifacts/macos/pasc
    
    - name: Build the Unit Tests Application (win64)
      run: lazbuild "tests/TestPasc.lpi" -B --os=darwin
    - run: cp tests/TestPasc ~/artifacts/macos/TestPasc
